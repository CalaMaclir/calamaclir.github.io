<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>PubliCryptDisp</title>
  <!-- 共通モジュールの読み込み -->
  <script type="module" src="common.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    h1, h2, h3 { margin-bottom: 10px; }
    #fileDropArea {
      border: 2px dashed #888;
      padding: 20px;
      text-align: center;
      margin-bottom: 10px;
    }
    table { border-collapse: collapse; width: 100%; margin-top: 10px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
    ul { list-style: none; padding-left: 0; }
    li { margin-bottom: 15px; padding: 5px; border-bottom: 1px dotted #aaa; }
    #headerOutput { margin-top: 10px; }
    .entry-info { margin-bottom: 3px; line-height: 1.4; }
    .identifier { word-break: break-all; white-space: pre-wrap; }
    .matched-key {
      background-color: #e0f7fa;
      color: #00796b;
      font-weight: bold;
      padding: 3px 6px;
      margin-top: 5px;
      border-radius: 4px;
      display: inline-block;
    }
  </style>
</head>
<body>
  <h1>PubliCryptDisp</h1>
  
  <!-- ファイルヘッダー解析セクション -->
  <section id="headerAnalysis">
    <h2>ファイルヘッダー解析</h2>
    <div id="fileDropArea">ここにファイルをドロップ</div>
    <input type="file" id="fileSelect">
    <button id="analyzeBtn">解析</button>
    <div id="headerOutput"></div>
  </section>
  
  <!-- 鍵一覧表示セクション -->
  <section id="keyListSection">
    <h2>鍵一覧</h2>
    <table id="keyTable">
      <thead>
        <tr>
          <th>鍵名</th>
          <th>種別</th>
          <th>鍵情報</th>
        </tr>
      </thead>
      <tbody>
        <!-- IndexedDB から読み込んだ鍵が表示される -->
      </tbody>
    </table>
  </section>
  
  <script type="module">
    import * as common from './common.js';

    // グローバル変数
    window.keyStore = {};
    window.importedPrivateKeys = [];

    // IndexedDB 初期化
    common.initDB(() => {
      loadKeysFromDB();
    });

    async function loadKeysFromDB() {
      // IndexedDB から鍵を読み込み、window.keyStore と window.importedPrivateKeys に反映する処理を実装
      refreshKeyList();
    }

    function refreshKeyList() {
      const tbody = document.getElementById("keyTable").querySelector("tbody");
      tbody.innerHTML = "";
      for (const keyName in window.keyStore) {
        const tr = document.createElement("tr");
        const tdName = document.createElement("td");
        tdName.textContent = keyName;
        const tdType = document.createElement("td");
        tdType.textContent = window.keyStore[keyName].type;
        const tdKeyInfo = document.createElement("td");
        if (window.keyStore[keyName].type === "RSA") {
          tdKeyInfo.textContent = window.keyStore[keyName].bitLength ? window.keyStore[keyName].bitLength + " bit" : "N/A";
        } else if (window.keyStore[keyName].type === "EC") {
          tdKeyInfo.textContent = window.keyStore[keyName].curve ? window.keyStore[keyName].curve : "N/A";
        } else {
          tdKeyInfo.textContent = "N/A";
        }
        tr.appendChild(tdName);
        tr.appendChild(tdType);
        tr.appendChild(tdKeyInfo);
        tbody.appendChild(tr);
      }
    }

    // ファイルヘッダー解析処理
    let fileToAnalyze = null;
    const fileDropArea = document.getElementById("fileDropArea");
    const fileSelect = document.getElementById("fileSelect");
    const headerOutputDiv = document.getElementById("headerOutput");

    fileDropArea.addEventListener("dragover", (e) => {
      e.preventDefault();
      fileDropArea.style.borderColor = "#000";
    });
    fileDropArea.addEventListener("dragleave", (e) => {
      e.preventDefault();
      fileDropArea.style.borderColor = "#888";
    });
    fileDropArea.addEventListener("drop", (e) => {
      e.preventDefault();
      fileDropArea.style.borderColor = "#888";
      if (e.dataTransfer.files.length > 0) {
        fileToAnalyze = e.dataTransfer.files[0];
        fileDropArea.textContent = fileToAnalyze.name;
      }
    });
    fileSelect.addEventListener("change", (e) => {
      if (e.target.files.length > 0) {
        fileToAnalyze = e.target.files[0];
        fileDropArea.textContent = fileToAnalyze.name;
      }
    });

    document.getElementById("analyzeBtn").addEventListener("click", () => {
      if (!fileToAnalyze) {
        alert("解析するファイルを選択してください。");
        return;
      }
      const reader = new FileReader();
      reader.onload = function(e) {
        const buffer = e.target.result;
        const headerLines = common.parseFileHeader(buffer, window.importedPrivateKeys);
        let html = "<h3>ヘッダー情報</h3><ul>";
        headerLines.forEach(line => {
          html += `<li>${line}</li>`;
        });
        html += "</ul>";
        headerOutputDiv.innerHTML = html;
      };
      reader.readAsArrayBuffer(fileToAnalyze);
    });
  </script>
</body>
</html>
